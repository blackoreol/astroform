<!DOCTYPE html>  
<html lang="ru">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">  
    <title>–ê—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –∞–Ω–∫–µ—Ç–∞</title>  
    <script src="https://telegram.org/js/telegram-web-app.js"></script>  
    <style>  
        :root { --primary-color: #667eea; --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);  
        --border-color: #e2e8f0; --text-color: #4a5568; --bg-light: #f7fafc;  
        --success-color: #48bb78; --error-color: #f56565; --error-bg: #ffeaea; }  
        * {margin: 0; padding: 0; box-sizing: border-box;}  
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--primary-gradient); min-height: 100vh; padding: 15px; color: #333; font-size: 16px; }  
        .container { max-width: 480px; margin: 0 auto; background: rgba(255,255,255,0.97); border-radius: 20px; padding: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); backdrop-filter: blur(10px);}  
        h1 {text-align: center; color: var(--text-color); margin-bottom: 25px; font-size: 22px; background: var(--primary-gradient); -webkit-background-clip: text; background-clip: text; color: transparent;}  
        .form-group {margin-bottom:20px; position:relative;}  
        .form-group.hidden { display: none; }  
        label {display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-color); font-size: 14px;}  
        input, select {width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 12px; font-size: 16px; transition: all 0.3s ease; background: white;}  
        input:focus, select:focus {border-color: var(--primary-color);}  
        input.error, select.error {border-color: var(--error-color); background: var(--error-bg);}  
        input[type="time"] { -webkit-appearance: textfield; }  
        .date-picker-trigger{ display: flex; align-items: center; justify-content: flex-start; padding: 0 18px; height: 52px; min-width: 220px; width:100%; color: var(--text-color); font-size: 18px; font-weight: 500; background: #fff; border:2px solid var(--border-color); border-radius: 13px; cursor: pointer; transition: .16s; margin-bottom:0;}  
        .date-picker-trigger.placeholder { color: #b4b4b7; font-weight: 400; }  
        .date-picker-trigger:focus,.date-picker-trigger:hover {border-color:var(--primary-color);}  
        .date-picker-trigger svg{margin-left:10px;}  
        .picker-group { display: flex; height: 162px; align-items: center; border-radius: 13px; background: #f7faff; overflow: hidden; position: relative; width: 322px; max-width: 95vw; margin-bottom:17px; border: 2px solid #e2e8f0;}  
        .picker-col { flex: 1 1 0; height: 100%; overflow-y: scroll; position: relative; scroll-snap-type: y mandatory; }  
        .picker-col::-webkit-scrollbar {display: none;}  
        .picker-option { scroll-snap-align: center; text-align: center; font-size: 17px;padding: 15px 2px;color: #bcbcbc;transition: color 0.2s, font-size 0.2s; user-select: none;cursor: pointer; background:transparent;}  
        .picker-option.selected { color: #2d3748; background: #ececff; font-size: 21px; font-weight: bold; border-radius: 9px;}  
        .picker-col::before, .picker-col::after {content: ''; position: absolute;left: 0; right: 0;height: 47px; background: linear-gradient(white, transparent);z-index: 2; pointer-events: none;}  
        .picker-col::before { top: 0;}  
        .picker-col::after { bottom: 0; transform: scaleY(-1);}  
        .picker-group::after {content: ''; position: absolute; left: 0; right: 0; top:50%; transform:translateY(-50%); height:40px; background: rgba(76, 102, 234,0.07); z-index: 4; border-top:1.6px solid #667eea; border-bottom:1.6px solid #667eea; pointer-events:none;}  
        .modal-overlay { display:none; position:fixed;left:0;top:0;width:100vw;height:100vh;z-index:2000; background:rgba(0,0,0,0.13); align-items:center; justify-content:center;}  
        .modal-overlay.active{display:flex;}  
        .modal-box { width:370px;max-width:99vw;background:#fff; border-radius:18px;padding:27px 0 16px 0; box-shadow:0 8px 32px #0001; display:flex;flex-direction:column;align-items:center; }  
        .modal-actions {display:flex;gap:14px;justify-content:center;margin-top:4px;}  
        .modal-actions button {padding:9px 28px;font-size:16px;font-weight:600;border-radius:10px;border:none;cursor:pointer;transition:.13s}  
        .modal-actions .ok-btn {background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:#fff;}  
        .modal-actions .cancel-btn {background: #e7eaf2;color:#6673b9;}  
        .location-search-wrapper { position: relative; }  
        .suggestions { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 12px 12px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; }  
        .suggestion { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid var(--bg-light); transition: background-color 0.2s; }  
        .suggestion:hover { background-color: var(--bg-light);}  
        .checkbox-section {display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--bg-light); border-radius: 10px; border: 1px solid var(--border-color); margin-top: 10px; transition: background-color 0.2s ease; user-select: none; min-height: 36px;}  
        .checkbox-section:hover { background: #edf2f7; }  
        .checkbox-section label { margin: 0; font-weight: 500; width:auto; }  
        .time-group { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }  
        .time-group input[type="time"] { flex: 1 1 120px; }  
        .time-options-wrapper { display: flex; align-items: center; gap: 15px; flex-wrap: nowrap; }  
        .seconds-control { display: flex; align-items: center; gap: 8px; flex-shrink: 0;margin-top:0; }  
        #secondsInput { width: 80px; padding: 12px; display: none; }  
        .submit-btn { width: 100%; padding: 16px; background: var(--primary-gradient); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin-top: 10px; }  
        .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3); }  
        .submit-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }  
        .submit-btn.success { background: var(--success-color); }  
        .submit-btn.error { background: var(--error-color); }  
        .loading { text-align: center; color: var(--primary-color); margin: 15px 0 5px 0; display: none; }  
        .error-message { text-align: center; color: var(--error-color); font-size: 14px; margin-top: 15px; display: none; }  
        .field-error { color: var(--error-color); font-size: 13px; margin-top: 3px; min-height: 17px;}  
        .custom-checkbox {display: inline-flex; align-items: center; gap: 9px; cursor: pointer; user-select: none; font-weight: 500; font-size: 15px; margin-bottom: 0; position: relative;}  
        .custom-checkbox input[type="checkbox"] { opacity: 0; width: 0; height: 0; position: absolute;}  
        .custom-checkbox .checkmark { display: inline-block; width: 22px; height: 22px; border: 2px solid var(--primary-color); border-radius: 6px; background: #fff; transition: background 0.18s, border-color 0.18s; position: relative; box-sizing: border-box;}  
        .custom-checkbox input[type="checkbox"]:checked + .checkmark { background: var(--primary-gradient); border-color: var(--primary-color);}  
        .custom-checkbox .checkmark::after {content: "";position: absolute; display: none; width: 7px; height: 12px; left: 6px; top: 2px; border: solid #fff; border-width: 0 3px 3px 0; border-radius: 1.5px; transform: rotate(45deg);}  
        .custom-checkbox input[type="checkbox"]:checked + .checkmark::after { display: block;}  
        .custom-checkbox input[type="checkbox"]:focus + .checkmark {box-shadow: 0 0 0 3px rgba(102,126,234,0.17);}  
        .custom-checkbox:hover .checkmark { border-color: #354cc8; }  
        .input-loader {  
            position: absolute;  
            right: 14px;  
            top: 50%;  
            transform: translateY(-50%);  
            width: 22px; height: 22px;  
            display: none;  
        }  
        .input-loader.active { display: block;}  
        .input-clear-btn {  
            position: absolute;  
            right: 40px;  
            top: 50%;  
            transform: translateY(-50%);  
            background: none;  
            border: none;  
            font-size: 19px;  
            color: #bbb;  
            cursor: pointer;  
            display: none;  
        }  
        .input-clear-btn.active { display: block; }  
        /* –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è —Ñ–æ–∫—É—Å–æ–º –∫–æ–ª–µ—Å */  
        .picker-col:focus,  
        .picker-col:focus-visible,  
        .picker-option:focus,  
        .picker-option:focus-visible,  
        .picker-group *:focus,  
        .picker-group *:focus-visible {  
            outline: none !important;  
            box-shadow: none !important;  
        }  
    </style>  
</head>  
<body>  
<div class="container">  
    <h1>üåü –ê—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –∞–Ω–∫–µ—Ç–∞</h1>  
    <form id="astroForm" autocomplete="off" novalidate>  
        <div class="form-group">  
            <label for="name">–ò–º—è *</label>  
            <input type="text" id="name" name="name" required placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è" aria-required="true" autocomplete="off">  
            <div class="field-error" id="error-name"></div>  
        </div>  
        <div class="form-group">  
            <label>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è *</label>  
            <button type="button" class="date-picker-trigger placeholder" id="openPickerBtn" tabindex="0" aria-label="–í—ã–±—Ä–∞—Ç—å –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è">  
                <span id="displayBirthDate">–ì–æ–¥ / –ú–µ—Å—è—Ü / –î–µ–Ω—å</span>  
                <svg width="18" height="18"><path fill="currentColor" d="M6 8l3 3 3-3z"></path></svg>  
            </button>  
            <input type="hidden" id="birthYear" name="birthYear" required>  
            <input type="hidden" id="birthMonth" name="birthMonth" required>  
            <input type="hidden" id="birthDay" name="birthDay" required>  
            <div class="field-error" id="error-birthDate"></div>  
        </div>  
        <div class="form-group" id="birthTimeFormGroup">  
            <label for="birthTime" id="birthTimeLabel">–í—Ä–µ–º—è —Ä–æ–∂–¥–µ–Ω–∏—è *</label>  
            <div class="time-group" id="timeControlsContainer">  
                <input type="time" id="birthTime" name="birthTime" required step="60" aria-required="true">  
                <div class="time-options-wrapper">  
                    <div class="seconds-control" id="secondsControl">  
                        <label class="custom-checkbox">  
                            <input type="checkbox" id="includeSeconds">  
                            <span class="checkmark"></span>  
                            <span style="font-weight:400;font-size:15px;">–°–µ–∫—É–Ω–¥—ã</span>  
                        </label>  
                        <input type="number" id="secondsInput" min="0" max="59" placeholder="00">  
                    </div>  
                </div>  
            </div>  
            <div class="checkbox-section" id="timeUnknownSection">  
                <label class="custom-checkbox">  
                    <input type="checkbox" id="timeUnknown">  
                    <span class="checkmark"></span>  
                    –ù–µ –∑–Ω–∞—é –≤—Ä–µ–º—è —Ä–æ–∂–¥–µ–Ω–∏—è  
                </label>  
            </div>  
            <div class="field-error" id="error-birthTime"></div>  
        </div>  
        <div class="form-group">  
            <label for="location">–ú–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è *</label>  
            <div class="location-search-wrapper">  
                <input type="text" id="location" name="location" required placeholder="–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥ —Ä–æ–∂–¥–µ–Ω–∏—è" autocomplete="off" aria-required="true">  
                <button class="input-clear-btn" id="clearLocationBtn" type="button" aria-label="–û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ">&#10005;</button>  
                <span class="input-loader" id="locationLoader">  
                    <svg width="22" height="22" viewBox="0 0 50 50">  
                        <circle cx="25" cy="25" r="20" fill="none" stroke="#667eea" stroke-width="5" stroke-linecap="round" stroke-dasharray="31.4 31.4" transform="rotate(-90 25 25)">  
                            <animateTransform attributeName="transform" type="rotate" values="0 25 25;360 25 25" dur="1s" repeatCount="indefinite"/>  
                        </circle>  
                    </svg>  
                </span>  
                <div id="suggestions" class="suggestions" role="listbox"></div>  
            </div>  
            <div class="checkbox-section">  
                <label class="custom-checkbox">  
                    <input type="checkbox" id="livesElsewhere">  
                    <span class="checkmark"></span>  
                    –ü—Ä–æ–∂–∏–≤–∞—é –≤ –¥—Ä—É–≥–æ–º –º–µ—Å—Ç–µ  
                </label>  
            </div>  
            <div class="field-error" id="error-location"></div>  
        </div>  
        <div class="form-group hidden" id="currentCityGroup">  
            <label for="currentCity">–ì–æ—Ä–æ–¥ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è *</label>  
            <div class="location-search-wrapper">  
                <input type="text" id="currentCity" name="currentCity" placeholder="–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥, –≥–¥–µ –∂–∏–≤–µ—Ç–µ —Å–µ–π—á–∞—Å" autocomplete="off" aria-required="true">  
                <button class="input-clear-btn" id="clearCurrentCityBtn" type="button" aria-label="–û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ">&#10005;</button>  
                <span class="input-loader" id="currentCityLoader">  
                    <svg width="22" height="22" viewBox="0 0 50 50">  
                        <circle cx="25" cy="25" r="20" fill="none" stroke="#667eea" stroke-width="5" stroke-linecap="round" stroke-dasharray="31.4 31.4" transform="rotate(-90 25 25)">  
                            <animateTransform attributeName="transform" type="rotate" values="0 25 25;360 25 25" dur="1s" repeatCount="indefinite"/>  
                        </circle>  
                    </svg>  
                </span>  
                <div id="currentCitySuggestions" class="suggestions" role="listbox"></div>  
            </div>  
            <div class="field-error" id="error-currentCity"></div>  
        </div>  
        <div class="form-group">  
            <label for="gender">–ü–æ–ª *</label>  
            <select id="gender" name="gender" required aria-required="true">  
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª</option>  
                <option value="male">–ú—É–∂—Å–∫–æ–π</option>  
                <option value="female">–ñ–µ–Ω—Å–∫–∏–π</option>  
            </select>  
            <div class="field-error" id="error-gender"></div>  
        </div>  
        <div class="form-group">  
            <label for="email">Email</label>  
            <input type="email" id="email" name="email" autocomplete="off" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à email (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">  
            <div class="field-error" id="error-email"></div>  
        </div>  
        <div id="loading" class="loading">–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>  
        <div id="errorMessage" class="error-message"></div>  
        <button type="submit" class="submit-btn" id="submitBtn" tabindex="0">‚ú® –û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>  
    </form>  
</div>  
<div class="modal-overlay" id="pickerModal" aria-modal="true" role="dialog">  
    <div class="modal-box">  
        <div class="picker-group">  
            <div class="picker-col" id="yearWheel" tabindex="0" aria-label="–ì–æ–¥"></div>  
            <div class="picker-col" id="monthWheel" tabindex="0" aria-label="–ú–µ—Å—è—Ü"></div>  
            <div class="picker-col" id="dayWheel" tabindex="0" aria-label="–î–µ–Ω—å"></div>  
        </div>  
        <div class="modal-actions">  
            <button type="button" class="ok-btn" id="pickerOk">OK</button>  
            <button type="button" class="cancel-btn" id="pickerCancel">–û—Ç–º–µ–Ω–∞</button>  
        </div>  
    </div>  
</div>  
<script>  
/* --- –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è --- */  
const lang = {  
    nameRequired: "–í–≤–µ–¥–∏—Ç–µ –∏–º—è",  
    birthDateRequired: "–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è",  
    birthTimeRequired: "–£–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è —Ä–æ–∂–¥–µ–Ω–∏—è",  
    locationRequired: "–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è –∏–∑ —Å–ø–∏—Å–∫–∞",  
    currentCityRequired: "–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è –∏–∑ —Å–ø–∏—Å–∫–∞",  
    genderRequired: "–£–∫–∞–∂–∏—Ç–µ –ø–æ–ª",  
    emailInvalid: "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π Email",  
};  
/* --- –ö—ç—à –¥–ª—è –ø–æ–∏—Å–∫–∞ –≥–æ—Ä–æ–¥–æ–≤ --- */  
const cityCache = new Map();  
  
/* --- –ö–æ–ª–µ—Å–æ –¥–∞—Ç—ã —Ä–æ–∂–¥–µ–Ω–∏—è --- */  
const monthNamesRu = ['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];  
const startYear = 1960, endYear = new Date().getFullYear();  
const yearWheel = document.getElementById('yearWheel');  
const monthWheel = document.getElementById('monthWheel');  
const dayWheel = document.getElementById('dayWheel');  
const birthYearInput = document.getElementById('birthYear');  
const birthMonthInput = document.getElementById('birthMonth');  
const birthDayInput = document.getElementById('birthDay');  
const openPickerBtn = document.getElementById('openPickerBtn');  
const displayBirthDate = document.getElementById('displayBirthDate');  
const pickerModal = document.getElementById('pickerModal');  
const okBtn = document.getElementById('pickerOk');  
const cancelBtn = document.getElementById('pickerCancel');  
let selectedYear = endYear, selectedMonth = 1, selectedDay = 1;  
let yearsList = [], monthsList = [], daysList = [];  
function makeLoopArray(arr, padding) {  
    let before = arr.slice(-padding);  
    let after = arr.slice(0, padding);  
    return before.concat(arr).concat(after);  
}  
function fillYearWheel() {  
    yearsList = [];  
    for(let i=endYear;i>=startYear;i--) yearsList.push(i);  
    const loopArr = makeLoopArray(yearsList, 2);  
    yearWheel.innerHTML = '';  
    loopArr.forEach(y=>{  
        let div=document.createElement('div');  
        div.className='picker-option';  
        div.innerText=y;  
        div.dataset.value=y;  
        yearWheel.appendChild(div);  
    });  
}  
function fillMonthWheel() {  
    monthsList = [];  
    for(let i=0;i<12;i++) monthsList.push(i+1);  
    const loopArr = makeLoopArray(monthsList, 2);  
    monthWheel.innerHTML = '';  
    loopArr.forEach(m=>{  
        let div=document.createElement('div');  
        div.className='picker-option';  
        div.innerText=monthNamesRu[m-1];  
        div.dataset.value=m;  
        monthWheel.appendChild(div);  
    });  
}  
function fillDayWheel() {  
    let days = 28;  
    if(selectedYear && selectedMonth) days = new Date(selectedYear, selectedMonth, 0).getDate();  
    daysList = Array.from({length:days}, (_,i)=>i+1);  
    const loopArr = makeLoopArray(daysList, 2);  
    dayWheel.innerHTML = '';  
    loopArr.forEach(d=>{  
        let div=document.createElement('div');  
        div.className='picker-option';  
        div.innerText=d;  
        div.dataset.value=d;  
        dayWheel.appendChild(div);  
    });  
}  
function getLoopRealIndex(val, arr) { let base = arr.indexOf(val); return base + 2; }  
function getValueFromScroll(wheel, arr) {  
    const bounding = wheel.getBoundingClientRect();  
    const center = bounding.y + bounding.height/2;  
    let minDist = Infinity, idx=0;  
    [...wheel.children].forEach((el,i)=>{  
        const rect = el.getBoundingClientRect();  
        const optCenter = rect.y + rect.height/2;  
        const dist = Math.abs(center-optCenter);  
        if(dist<minDist){minDist=dist;idx = i;}  
    });  
    let realVal = +wheel.children[idx].dataset.value;  
    return {idx, realVal};  
}  
function scrollToValue(wheel, arr, val) {  
    let idx = getLoopRealIndex(val, arr);  
    if (wheel.children[idx]) wheel.scrollTop = wheel.children[idx].offsetTop - (wheel.clientHeight/2) + (wheel.children[idx].clientHeight/2);  
}  
function highlightWheel(wheel, arr, val) {  
    [...wheel.children].forEach((el,i)=>el.classList.toggle('selected', +el.dataset.value===val));  
}  
function scrollDetectLoop(wheel, arr) {  
    let firstItemTop = wheel.children[0].offsetTop;  
    let lastPaddingItemTop = wheel.children[wheel.children.length-1].offsetTop;  
    if (wheel.scrollTop < firstItemTop + 10) {  
        setTimeout(()=>scrollToValue(wheel, arr, arr[arr.length-2]),1);  
    } else if (wheel.scrollTop > lastPaddingItemTop - wheel.clientHeight - 10) {  
        setTimeout(()=>scrollToValue(wheel, arr, arr[1]),1);  
    }  
}  
// === –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –≤—ã–¥–µ–ª–µ–Ω–∏–µ .selected –ú–ì–ù–û–í–ï–ù–ù–û ===  
yearWheel.addEventListener('scroll', function(){  
    scrollDetectLoop(yearWheel, yearsList);  
    clearTimeout(yearWheel._st);  
    yearWheel._st = setTimeout(()=>{  
        let {realVal}=getValueFromScroll(yearWheel, yearsList);  
        selectedYear = realVal;  
        highlightWheel(yearWheel, yearsList, selectedYear);  
        fillDayWheel();  
        scrollToValue(dayWheel, daysList, selectedDay);  
        highlightWheel(dayWheel, daysList, selectedDay);  
    }, 0);  
});  
yearWheel.addEventListener('click', function(e){  
    if(e.target.classList.contains('picker-option')){  
        selectedYear = +e.target.dataset.value;  
        scrollToValue(yearWheel, yearsList, selectedYear);  
        highlightWheel(yearWheel, yearsList, selectedYear);  
        fillDayWheel();  
        scrollToValue(dayWheel, daysList, selectedDay);  
        highlightWheel(dayWheel, daysList, selectedDay);  
    }  
});  
monthWheel.addEventListener('scroll', function(){  
    scrollDetectLoop(monthWheel, monthsList);  
    clearTimeout(monthWheel._st);  
    monthWheel._st = setTimeout(()=>{  
        let {realVal}=getValueFromScroll(monthWheel, monthsList);  
        selectedMonth = realVal;  
        highlightWheel(monthWheel, monthsList, selectedMonth);  
        fillDayWheel();  
        scrollToValue(dayWheel, daysList, selectedDay);  
        highlightWheel(dayWheel, daysList, selectedDay);  
    },0);  
});  
monthWheel.addEventListener('click', function(e){  
    if(e.target.classList.contains('picker-option')){  
        selectedMonth = +e.target.dataset.value;  
        scrollToValue(monthWheel, monthsList, selectedMonth);  
        highlightWheel(monthWheel, monthsList, selectedMonth);  
        fillDayWheel();  
        scrollToValue(dayWheel, daysList, selectedDay);  
        highlightWheel(dayWheel, daysList, selectedDay);  
    }  
});  
dayWheel.addEventListener('scroll', function(){  
    scrollDetectLoop(dayWheel, daysList);  
    clearTimeout(dayWheel._st);  
    dayWheel._st = setTimeout(()=>{  
        let {realVal}=getValueFromScroll(dayWheel, daysList);  
        selectedDay = realVal;  
        highlightWheel(dayWheel, daysList, selectedDay);  
    }, 0);  
});  
dayWheel.addEventListener('click', function(e){  
    if(e.target.classList.contains('picker-option')){  
        selectedDay = +e.target.dataset.value;  
        scrollToValue(dayWheel, daysList, selectedDay);  
        highlightWheel(dayWheel, daysList, selectedDay);  
    }  
});  
function showSelectedBirthDate() {  
    const hasRealDate = birthYearInput.value && birthMonthInput.value && birthDayInput.value;  
    if(hasRealDate) {  
        displayBirthDate.textContent = `${birthYearInput.value} ${monthNamesRu[Number(birthMonthInput.value)-1]} ${birthDayInput.value}`;  
        openPickerBtn.classList.remove('placeholder');  
    } else {  
        displayBirthDate.textContent = '–ì–æ–¥ / –ú–µ—Å—è—Ü / –î–µ–Ω—å';  
        openPickerBtn.classList.add('placeholder');  
    }  
}  
function openPicker() {  
    fillYearWheel(); fillMonthWheel(); fillDayWheel();  
    scrollToValue(yearWheel, yearsList, selectedYear);  
    highlightWheel(yearWheel, yearsList, selectedYear);  
    scrollToValue(monthWheel, monthsList, selectedMonth);  
    highlightWheel(monthWheel, monthsList, selectedMonth);  
    scrollToValue(dayWheel, daysList, selectedDay);  
    highlightWheel(dayWheel, daysList, selectedDay);  
    pickerModal.classList.add('active');  
    setTimeout(()=>yearWheel.focus(), 100);  
}  
function closePicker(){pickerModal.classList.remove('active');}  
okBtn.addEventListener('click', ()=>{  
    closePicker();  
    birthYearInput.value = selectedYear;  
    birthMonthInput.value = selectedMonth;  
    birthDayInput.value = selectedDay;  
    showSelectedBirthDate();  
    saveDraft();  
});  
openPickerBtn.addEventListener('click', openPicker);  
cancelBtn.addEventListener('click', ()=>{closePicker();});  
window.addEventListener('keydown', function(e){ if(pickerModal.classList.contains('active') && (e.key==='Escape')) closePicker(); });  
showSelectedBirthDate();  
  
/* --- –°–µ–∫—É–Ω–¥—ã –≤ –≤—Ä–µ–º–µ–Ω–∏ —Ä–æ–∂–¥–µ–Ω–∏—è --- */  
(function setupSecondsCheckbox(){  
    const checkbox=document.getElementById('includeSeconds');  
    const secondsInput=document.getElementById('secondsInput');  
    checkbox.addEventListener('change',function(){  
        if(this.checked){  
            secondsInput.style.display='block';secondsInput.focus();  
        }else{  
            secondsInput.style.display='none';secondsInput.value='';  
        }  
        saveDraft();  
    });  
    secondsInput.addEventListener('input', saveDraft);  
})();  
  
/* --- –ù–µ –∑–Ω–∞—é –≤—Ä–µ–º—è —Ä–æ–∂–¥–µ–Ω–∏—è --- */  
(function setupUnknownTimeCheckbox(){  
    const timeUnknownCheckbox=document.getElementById('timeUnknown');  
    const birthTimeLabel=document.getElementById('birthTimeLabel');  
    const timeControlsContainer=document.getElementById('timeControlsContainer');  
    const birthTimeInput=document.getElementById('birthTime');  
    function handleTimeUnknownChange(){  
        const isTimeUnknown=timeUnknownCheckbox.checked;  
        birthTimeLabel.style.display=isTimeUnknown?'none':'block';  
        timeControlsContainer.style.display=isTimeUnknown?'none':'flex';  
        if(isTimeUnknown){  
            birthTimeInput.required=false;  
            birthTimeInput.value='';  
            const includeSecondsCheckbox=document.getElementById('includeSeconds');  
            const secondsInput=document.getElementById('secondsInput');  
            includeSecondsCheckbox.checked=false;  
            secondsInput.value='';  
            secondsInput.style.display='none';  
        }else{  
            birthTimeInput.required=true;  
        }  
        saveDraft();  
    }  
    timeUnknownCheckbox.addEventListener('change',handleTimeUnknownChange);  
})();  
  
/* --- –ì–æ—Ä–æ–¥ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è --- */  
(function setupCurrentCityCheckbox(){  
    const checkbox=document.getElementById('livesElsewhere');  
    const currentCityGroup=document.getElementById('currentCityGroup');  
    const currentCityInput=document.getElementById('currentCity');  
    function toggleCurrentCityField(){  
        if(checkbox.checked){  
            currentCityGroup.classList.remove('hidden');  
            currentCityInput.required=true;  
            setTimeout(()=>currentCityInput.focus(),100);  
        }else{  
            currentCityGroup.classList.add('hidden');  
            currentCityInput.required=false;  
            currentCityInput.value='';  
            selectedCurrentCity=null;  
            document.getElementById('currentCitySuggestions').style.display='none';  
        }  
        saveDraft();  
    }  
    checkbox.addEventListener('change',toggleCurrentCityField);  
})();  
  
/* --- –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª—è –≥–æ—Ä–æ–¥–∞ --- */  
document.getElementById('clearLocationBtn').onclick = function() {  
    document.getElementById('location').value = '';  
    selectedLocation = null;  
    document.getElementById('suggestions').style.display = 'none';  
    this.classList.remove("active");  
    saveDraft();  
};  
document.getElementById('clearCurrentCityBtn').onclick = function() {  
    document.getElementById('currentCity').value = '';  
    selectedCurrentCity = null;  
    document.getElementById('currentCitySuggestions').style.display = 'none';  
    this.classList.remove("active");  
    saveDraft();  
};  
  
/* --- –ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞ --- */  
let selectedLocation = null, selectedCurrentCity = null, searchTimeout, currentCitySearchTimeout;  
async function searchLocations(query, type) {  
    const cacheKey = type + ':' + query.toLowerCase();  
    if (cityCache.has(cacheKey)) {  
        displaySuggestions(cityCache.get(cacheKey), type);  
        return;  
    }  
    showInputLoader(type, true);  
    try {  
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=5&q=${encodeURIComponent(query)}&addressdetails=1&accept-language=ru`);  
        const locations = await response.json();  
        cityCache.set(cacheKey, locations);  
        displaySuggestions(locations, type);  
    } catch (error) {console.error('Location search error:', error);}  
    showInputLoader(type, false);  
}  
function showInputLoader(type, show) {  
    let loader = type === 'birth' ? document.getElementById('locationLoader') : document.getElementById('currentCityLoader');  
    if(loader) loader.classList.toggle("active", show);  
}  
function displaySuggestions(locations, type) {  
    const suggestionsContainer = type === 'birth' ? document.getElementById('suggestions') : document.getElementById('currentCitySuggestions');  
    const inputField = type === 'birth' ? document.getElementById('location') : document.getElementById('currentCity');  
    suggestionsContainer.innerHTML = '';  
    if (locations.length === 0) {  
        suggestionsContainer.style.display = 'none';  
        return;  
    }  
    locations.forEach(location => {  
        const div = document.createElement('div');  
        div.className = 'suggestion';  
        div.setAttribute('role', 'option');  
        div.textContent = location.display_name;  
        div.addEventListener('click', () => {  
            inputField.value = location.display_name;  
            suggestionsContainer.style.display = 'none';  
            const locationData = {  
                city: location.address?.city || location.address?.town || location.address?.village || location.name,  
                country: location.address?.country || '',  
                country_code: location.address?.country_code || '',  
                full_address: location.display_name,  
                latitude: location.lat,  
                longitude: location.lon,  
            };  
            if (type === 'birth') { selectedLocation = locationData; } else { selectedCurrentCity = locationData; }  
            saveDraft();  
            // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É –æ—á–∏—Å—Ç–∫–∏  
            if(type==='birth') document.getElementById('clearLocationBtn').classList.add("active");  
            else document.getElementById('clearCurrentCityBtn').classList.add("active");  
        });  
        suggestionsContainer.appendChild(div);  
    });  
    suggestionsContainer.style.display = 'block';  
}  
document.getElementById('location').addEventListener('input', function() {  
    const query = this.value.trim(); selectedLocation = null;  
    document.getElementById('clearLocationBtn').classList.toggle("active", !!query);  
    if (query.length < 3) {document.getElementById('suggestions').style.display = 'none';return;}  
    clearTimeout(searchTimeout);  
    searchTimeout = setTimeout(() => searchLocations(query, 'birth'), 300);  
    saveDraft();  
});  
document.getElementById('currentCity').addEventListener('input', function() {  
    const query = this.value.trim(); selectedCurrentCity = null;  
    document.getElementById('clearCurrentCityBtn').classList.toggle("active", !!query);  
    if (query.length < 3) {document.getElementById('currentCitySuggestions').style.display = 'none';return;}  
    clearTimeout(currentCitySearchTimeout);  
    currentCitySearchTimeout = setTimeout(() => searchLocations(query, 'current'), 300);  
    saveDraft();  
});  
document.addEventListener('click', function(e) {  
    if (!e.target.closest('.location-search-wrapper') && !e.target.closest('.form-group .date-container')) {  
        document.getElementById('suggestions').style.display = 'none';  
        document.getElementById('currentCitySuggestions').style.display = 'none';  
    }  
});  
  
/* --- Inline-–≤–∞–ª–∏–¥–∞—Ü–∏—è --- */  
function showFieldError(id, msg) {  
    document.getElementById('error-'+id).textContent = msg || '';  
    let field = document.getElementById(id);  
    if(field) field.classList.toggle('error', !!msg);  
}  
function clearAllErrors() {  
    [  
        'name','birthDate','birthTime','location','currentCity','gender','email'  
    ].forEach(id=>showFieldError(id,''));  
    document.getElementById('errorMessage').style.display = 'none';  
}  
  
/* --- –ß–µ—Ä–Ω–æ–≤–∏–∫ —Ñ–æ—Ä–º—ã (localStorage) --- */  
function saveDraft(){  
    const draft = {  
        name: document.getElementById('name').value,  
        birthYear: birthYearInput.value,  
        birthMonth: birthMonthInput.value,  
        birthDay: birthDayInput.value,  
        birthTime: document.getElementById('birthTime').value,  
        includeSeconds: document.getElementById('includeSeconds').checked,  
        secondsInput: document.getElementById('secondsInput').value,  
        timeUnknown: document.getElementById('timeUnknown').checked,  
        location: document.getElementById('location').value,  
        livesElsewhere: document.getElementById('livesElsewhere').checked,  
        currentCity: document.getElementById('currentCity').value,  
        gender: document.getElementById('gender').value,  
        email: document.getElementById('email').value,  
        selectedLocation: selectedLocation,  
        selectedCurrentCity: selectedCurrentCity  
    };  
    localStorage.setItem('astroFormDraft', JSON.stringify(draft));  
}  
function restoreDraft(){  
    let d = localStorage.getItem('astroFormDraft');  
    if(!d) return;  
    try{  
        let draft = JSON.parse(d);  
        document.getElementById('name').value = draft.name || '';  
        birthYearInput.value = draft.birthYear || '';  
        birthMonthInput.value = draft.birthMonth || '';  
        birthDayInput.value = draft.birthDay || '';  
        if (birthYearInput.value && birthMonthInput.value && birthDayInput.value) {  
            selectedYear = +birthYearInput.value;  
            selectedMonth = +birthMonthInput.value;  
            selectedDay = +birthDayInput.value;  
        }  
        showSelectedBirthDate();  
        document.getElementById('birthTime').value = draft.birthTime || '';  
        document.getElementById('includeSeconds').checked = !!draft.includeSeconds;  
        document.getElementById('secondsInput').value = draft.secondsInput || '';  
        document.getElementById('secondsInput').style.display = draft.includeSeconds ? 'block' : 'none';  
        document.getElementById('timeUnknown').checked = !!draft.timeUnknown;  
        document.getElementById('location').value = draft.location || '';  
        document.getElementById('livesElsewhere').checked = !!draft.livesElsewhere;  
        document.getElementById('currentCity').value = draft.currentCity || '';  
        document.getElementById('gender').value = draft.gender || '';  
        document.getElementById('email').value = draft.email || '';  
        if(draft.selectedLocation) selectedLocation = draft.selectedLocation;  
        if(draft.selectedCurrentCity) selectedCurrentCity = draft.selectedCurrentCity;  
        // –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–µ –≥–æ—Ä–æ–¥–∞ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ  
        if(draft.livesElsewhere) document.getElementById('currentCityGroup').classList.remove('hidden');  
    }catch(e){}  
}  
restoreDraft();  
  
/* --- Telegram: –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª–∞ --- */  
(function tgAutofillGender(){  
    let tg = window.Telegram?.WebApp?.initDataUnsafe?.user;  
    if(!tg) return;  
    const genderSelect = document.getElementById('gender');  
    if(genderSelect.value) return; // –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤—ã–±—Ä–∞–ª  
    if(tg && tg.username && tg.first_name){  
        document.getElementById('name').value = tg.first_name;  
        saveDraft();  
    }  
    if(tg && tg.gender){  
        if(tg.gender==='male') genderSelect.value = 'male';  
        if(tg.gender==='female') genderSelect.value = 'female';  
        saveDraft();  
    }  
})();  
  
/* --- –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã --- */  
function validateForm() {  
    clearAllErrors();  
    let firstInvalid = null, ok = true;  
    const name = document.getElementById('name').value.trim();  
    if(!name) { showFieldError('name', lang.nameRequired); ok=false; if(!firstInvalid) firstInvalid='name'; }  
    if(!birthYearInput.value || !birthMonthInput.value || !birthDayInput.value) {  
        showFieldError('birthDate', lang.birthDateRequired); ok=false; if(!firstInvalid) firstInvalid='openPickerBtn';  
    }  
    const isTimeUnknown = document.getElementById('timeUnknown').checked;  
    if(!isTimeUnknown && !document.getElementById('birthTime').checkValidity()){  
        showFieldError('birthTime', lang.birthTimeRequired); ok=false; if(!firstInvalid) firstInvalid='birthTime';  
    }  
    if(!selectedLocation) { showFieldError('location', lang.locationRequired); ok=false; if(!firstInvalid) firstInvalid='location'; }  
    const livesElsewhere = document.getElementById('livesElsewhere').checked;  
    if(livesElsewhere && !selectedCurrentCity) { showFieldError('currentCity', lang.currentCityRequired); ok=false; if(!firstInvalid) firstInvalid='currentCity'; }  
    const gender = document.getElementById('gender').value;  
    if(!gender) { showFieldError('gender', lang.genderRequired); ok=false; if(!firstInvalid) firstInvalid='gender'; }  
    const email = document.getElementById('email').value.trim();  
    if(email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {  
        showFieldError('email', lang.emailInvalid); ok=false; if(!firstInvalid) firstInvalid='email';  
    }  
    if(firstInvalid){  
        let el = document.getElementById(firstInvalid);  
        if(el) el.focus();  
    }  
    return ok;  
}  
  
/* --- –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã --- */  
document.getElementById('astroForm').addEventListener('submit', async function(e) {  
    e.preventDefault();  
    if(!validateForm()) return;  
    const isTimeUnknown = document.getElementById('timeUnknown').checked;  
    const birthDayValue = document.getElementById('birthDay').value;  
    const birthMonthValue = document.getElementById('birthMonth').value;  
    const birthYearValue = document.getElementById('birthYear').value;  
    const submitBtn = document.getElementById('submitBtn');  
    const loadingDiv = document.getElementById('loading');  
    const errorDiv = document.getElementById('errorMessage');  
    submitBtn.disabled = true; submitBtn.innerText = '‚ú® –û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ';  
    submitBtn.classList.remove('success', 'error');  
    errorDiv.style.display = 'none'; loadingDiv.style.display = 'block';  
    try {  
        const formData = new FormData(this);  
        const birthDay = String(birthDayValue).padStart(2, '0');  
        const birthMonth = String(birthMonthValue).padStart(2, '0');  
        const birthYear = birthYearValue;  
        const name = formData.get('name');  
        const email = formData.get('email') || '';  
        const gender = formData.get('gender');  
        const birthTime = isTimeUnknown ? '12:00' : formData.get('birthTime');  
        const includeSeconds = isTimeUnknown ? false : document.getElementById('includeSeconds').checked;  
        const seconds = includeSeconds ? (document.getElementById('secondsInput').value || '0').padStart(2, '0') : '00';  
        const birthDate = `${birthYear}-${birthMonth}-${birthDay}`;  
        const fullTime = `${birthTime}:${seconds}`;  
        const dateObj = new Date(`${birthDate}T${fullTime}`);  
        const tg = window.Telegram?.WebApp;  
        const data = {  
            name,email,gender,birthDate,birthTime,birthTimeWithSeconds: fullTime,includeSeconds,isTimeKnown: !isTimeUnknown,  
            birthLocation: selectedLocation,  
            currentCity: livesElsewhere ? selectedCurrentCity : selectedLocation,  
            livesElsewhere,  
            timestamp: new Date().toISOString(),  
            telegramUser: tg?.initDataUnsafe?.user || null,  
            telegramChatId: tg?.initDataUnsafe?.chat?.id || null,  
            separateComponents: {  
                year: dateObj.getFullYear(),  
                month: dateObj.getMonth() + 1,  
                day: dateObj.getDate(),  
                hour: dateObj.getHours(),  
                minute: dateObj.getMinutes(),  
                second: dateObj.getSeconds()  
            }  
        };  
        // –û—Ç–ø—Ä–∞–≤–∏–º –Ω–∞ –æ–±–∞ webhook  
        const testWebhookUrl = 'https://n8n.dkonzersky.pp.ua/webhook-test/telegram-form';  
        const prodWebhookUrl = 'https://n8n.dkonzersky.pp.ua/webhook/telegram-form';  
        const sendPromises = [  
            fetch(testWebhookUrl, {  
                method: 'POST',  
                headers: {'Content-Type': 'application/json'},  
                body: JSON.stringify(data)  
            }),  
            fetch(prodWebhookUrl, {  
                method: 'POST',  
                headers: {'Content-Type': 'application/json'},  
                body: JSON.stringify(data)  
            }),  
        ];  
        const results = await Promise.allSettled(sendPromises);  
        let success = false;  
        results.forEach(result=>{  
            if(result.status==='fulfilled' && result.value.ok) success=true;  
        });  
        loadingDiv.style.display = 'none';  
        if(success) {  
            submitBtn.classList.add('success');  
            submitBtn.innerText = '‚úÖ –£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ';  
            localStorage.removeItem('astroFormDraft');  
            if (window.Telegram?.WebApp?.close) {  
                setTimeout(() => { window.Telegram.WebApp.close(); }, 1700);  
            } else {  
                setTimeout(()=>{submitBtn.disabled=false;submitBtn.innerText="‚ú® –û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ";}, 2000);  
                setTimeout(()=>{document.getElementById('astroForm').reset();clearAllErrors();showSelectedBirthDate();}, 2000);  
            }  
        } else {  
            errorDiv.textContent = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';  
            errorDiv.style.display = 'block';  
            submitBtn.classList.add('error');  
            submitBtn.innerText = '‚ùå –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞';  
            submitBtn.disabled = false;  
        }  
    } catch (error) {  
        loadingDiv.style.display = 'none';  
        errorDiv.textContent = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';  
        errorDiv.style.display = 'block';  
        submitBtn.classList.add('error');  
        submitBtn.innerText = '‚ùå –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞';  
        submitBtn.disabled = false;  
    }  
});  
  
[  
    'name','birthTime','location','currentCity','gender','email'  
].forEach(id=>{  
    let el = document.getElementById(id);  
    if(el) el.addEventListener('input', ()=>{ showFieldError(id, ''); saveDraft(); });  
});  
document.getElementById('gender').addEventListener('change', ()=>{ showFieldError('gender',''); saveDraft(); });  
</script>  
</body>  
</html>  
