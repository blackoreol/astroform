<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Анкета для n8n (DEBUG)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root{--form-padding:20px;--form-radius:16px;--field-height:50px;--font-main:'Manrope',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif}@keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}body{font-family:var(--font-main);padding:var(--form-padding);color:var(--tg-theme-text-color);background-color:var(--tg-theme-bg-color);display:flex;justify-content:center;align-items:flex-start;min-height:100vh;box-sizing:border-box;animation:fadeIn .5s ease-out}.form-container{width:100%;max-width:420px;background-color:var(--tg-theme-secondary-bg-color);border-radius:var(--form-radius);padding:calc(var(--form-padding) + 10px);box-shadow:0 8px 32px rgba(0,0,0,.1)}h3{font-size:24px;font-weight:700;margin:0 0 25px;text-align:center}.form-group{margin-bottom:20px}.form-group label{display:flex;align-items:center;gap:8px;font-size:14px;font-weight:500;color:var(--tg-theme-hint-color);margin-bottom:8px}.form-group label svg{width:16px;height:16px;fill:currentColor}.form-group input{width:100%;height:var(--field-height);padding:0 15px;box-sizing:border-box;border-radius:10px;border:1.5px solid transparent;background-color:var(--tg-theme-bg-color);color:var(--tg-theme-text-color);font-size:16px;font-family:var(--font-main);transition:border-color .3s,box-shadow .3s}.form-group input:focus{outline:0;border-color:var(--tg-theme-button-color);box-shadow:0 0 0 3px color-mix(in srgb,var(--tg-theme-button-color) 20%,transparent)}.city-search-container{position:relative}#city-results{position:absolute;top:calc(100% + 5px);left:0;right:0;background:var(--tg-theme-secondary-bg-color);border:1.5px solid var(--tg-theme-hint-color);border-radius:10px;z-index:10;max-height:160px;overflow-y:auto;box-shadow:0 8px 16px rgba(0,0,0,.1);animation:fadeIn .3s}.result-item{padding:12px 15px;cursor:pointer;font-size:15px}.result-item:hover{background-color:var(--tg-theme-button-color);color:var(--tg-theme-button-text-color)}button[type=submit]{width:100%;height:var(--field-height);border:none;border-radius:10px;background-color:var(--tg-theme-button-color);color:var(--tg-theme-button-text-color);font-size:16px;font-weight:600;font-family:var(--font-main);cursor:pointer;transition:transform .2s,box-shadow .2s;margin-top:10px}button[type=submit]:active{transform:scale(.98)}
    </style>
</head>
<body>
    <div class="form-container">
        <h3>Анкета (Debug)</h3>
        <form id="mainForm">
            <div class="form-group"><label for="name"><svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg> Ваше имя</label><input type="text" id="name" placeholder="Например, Иван" required></div>
            <div class="form-group"><label for="birth-date"><svg viewBox="0 0 24 24"><path d="M17 12h-5v5h5v-5zM16 1v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-1V1h-2zm3 18H5V8h14v11z"/></svg> Дата рождения</label><input type="date" id="birth-date" required></div>
            <div class="form-group"><label for="birth-time"><svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg> Время рождения</label><input type="time" id="birth-time" required></div>
            <div class="form-group city-search-container"><label for="city-search"><svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg> Город</label><input type="text" id="city-search" placeholder="Начните поиск..." required autocomplete="off"><input type="hidden" id="selected-location-data"><div id="city-results"></div></div>
            <button type="submit">Отправить анкету</button>
        </form>
    </div>
    <script>
        Telegram.WebApp.ready();
        const nameInput=document.getElementById("name"),dateInput=document.getElementById("birth-date"),timeInput=document.getElementById("birth-time"),citySearchInput=document.getElementById("city-search"),cityResultsDiv=document.getElementById("city-results"),selectedLocationInput=document.getElementById("selected-location-data"),form=document.getElementById("mainForm");let debounceTimer;const searchCity=async e=>{if(e.length<3){cityResultsDiv.innerHTML="";return}const t=`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(e)}&format=json&addressdetails=1&accept-language=uk,en&limit=5`;try{const e=await fetch(t),a=await e.json();displayResults(a)}catch(e){console.error("Ошибка при поиске города:",e)}};const displayResults=e=>{cityResultsDiv.innerHTML="";if(!e)return;e.forEach(e=>{const t=document.createElement("div");t.className="result-item",t.innerText=e.display_name,t.onclick=()=>{citySearchInput.value=e.display_name;const a={city:e.address.city||e.address.town||e.address.village||"",country:e.address.country||"",full_address:e.display_name};selectedLocationInput.value=JSON.stringify(a),cityResultsDiv.innerHTML=""},cityResultsDiv.appendChild(t)})};citySearchInput.addEventListener("input",()=>{clearTimeout(debounceTimer),selectedLocationInput.value="",debounceTimer=setTimeout(()=>{searchCity(citySearchInput.value)},500)}),form.addEventListener("submit",(function(e){e.preventDefault(),console.log("1. Форма отправлена, начинаем обработку.");const t=nameInput.value,a=dateInput.value,n=timeInput.value,o=selectedLocationInput.value;if(console.log("2. Валидация полей..."),!t||!a||!n||!o)return console.error("3. ОШИБКА ВАЛИДАЦИИ! Не все поля заполнены."),void Telegram.WebApp.showAlert("Пожалуйста, заполните все поля и выберите город из выпадающего списка.");console.log("3. Валидация пройдена.");const i=JSON.parse(o),s={name:t,birthDate:a,birthTime:n,location:i};console.log("4. Данные для отправки готовы:",s),Telegram.WebApp.sendData(JSON.stringify(s)),console.log("5. Команда sendData вызвана."),Telegram.WebApp.isVersionAtLeast("6.1")?(console.log("6. Версия клиента > 6.1, показываем showAlert."),Telegram.WebApp.showAlert("Форма успешно отправлена!",(()=>{console.log("7. Пользователь нажал ОК, закрываем окно."),Telegram.WebApp.close()})):(console.log("6. Версия клиента < 6.1, просто закрываем окно."),Telegram.WebApp.close())}));
    </script>
</body>
</html>
