<script>
    // Инициализируем Telegram Web App
    Telegram.WebApp.ready();

    // Находим все наши элементы на странице
    const nameInput = document.getElementById('name');
    const dobInput = document.getElementById('dob');
    const citySearchInput = document.getElementById('city-search');
    const cityResultsDiv = document.getElementById('city-results');
    const selectedLocationInput = document.getElementById('selected-location-data');
    const form = document.getElementById('mainForm');

    let debounceTimer;

    // Функция поиска города (остается без изменений)
    const searchCity = async (query) => {
        if (query.length < 3) { cityResultsDiv.innerHTML = ''; return; }
        const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&addressdetails=1&accept-language=uk,en&limit=5`;
        try { const response = await fetch(url); const data = await response.json(); displayResults(data); } catch (error) { console.error('Ошибка при поиске города:', error); }
    };

    // Функция отображения результатов (остается без изменений)
    const displayResults = (results) => {
        cityResultsDiv.innerHTML = ''; if (!results) return;
        results.forEach(place => {
            const item = document.createElement('div'); item.className = 'result-item'; item.innerText = place.display_name;
            item.onclick = () => {
                citySearchInput.value = place.display_name;
                const locationData = { city: place.address.city || place.address.town || place.address.village || '', country: place.address.country || '', full_address: place.display_name };
                selectedLocationInput.value = JSON.stringify(locationData); cityResultsDiv.innerHTML = '';
            };
            cityResultsDiv.appendChild(item);
        });
    };

    // Слушатель ввода (остается без изменений)
    citySearchInput.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        selectedLocationInput.value = '';
        debounceTimer = setTimeout(() => {
            searchCity(citySearchInput.value);
        }, 500);
    });

    // === НАЧАЛО ИЗМЕНЕНИЙ ===

    // Обработчик отправки формы
    form.addEventListener('submit', function(event) {
        event.preventDefault();
        
        const name = nameInput.value;
        const dob = dobInput.value;
        const locationDataString = selectedLocationInput.value;

        // 1. Валидация данных (как и раньше)
        if (!name || !dob || !locationDataString) {
            Telegram.WebApp.showAlert('Пожалуйста, заполните все поля и выберите город из выпадающего списка.');
            return;
        }

        const locationData = JSON.parse(locationDataString);
        const finalData = {
            name: name,
            dob: dob,
            location: locationData
        };

        // 2. Отправляем данные в n8n (как и раньше)
        Telegram.WebApp.sendData(JSON.stringify(finalData));

        // 3. НОВИНКА: Показываем уведомление об успехе
        // Второй аргумент - это функция, которая выполнится ПОСЛЕ нажатия "ОК"
        Telegram.WebApp.showAlert('Форма успешно отправлена!', () => {
            // 4. НОВИНКА: Закрываем окно Web App
            Telegram.WebApp.close();
        });
    });

    // === КОНЕЦ ИЗМЕНЕНИЙ ===
</script>
